FROM openjdk:11.0.9.1-jdk as builder
USER root
ADD . /builder
WORKDIR /builder
# Add GRADLE_OPTS to prevent JVM forking while building
# Skip integration tests when building the local docker image
RUN GRADLE_OPTS="-XX:MaxMetaspaceSize=256m -XX:+HeapDumpOnOutOfMemoryError -Xms256m -Xmx512m" ./gradlew build --no-daemon -x :services:hanke-service:integrationTest

FROM openjdk:11
WORKDIR /app
EXPOSE 8080 8081
COPY --from=builder /builder/services/hanke-service/build/libs/hanke-service-*.jar /app/haitaton.jar
COPY --from=builder /builder/scripts/wait-for-it.sh /app/wait-for-it.sh
CMD ["java", "-jar", "haitaton.jar" ]
